<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Marker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='footer.css') }}" />
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMLA-4L8ZtfBjHB3Wp-9vB83dyL4eQmbM&libraries=places&callback=initMap" defer></script>
    <link rel="stylesheet" href="{{url_for('static',filename='landsat.css')}}">
    <script>
        let map, marker, lng, lat;
        document.addEventListener("DOMContentLoaded", function() {
            const startButton = document.createElement("button");
            startButton.id = "start-button";
            startButton.innerText = "Start Landsat";
            document.body.insertBefore(startButton, document.getElementById("container"));

            startButton.onclick = function () {
                document.getElementById("container").style.display = "flex"; // Show the container
                this.style.display = "none"; // Hide the start button

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Create the map centered at the user's location
                        map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 14,
                            center: userLocation
                        });

                        // Add a marker at the user's location
                        marker = new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: 'You are here!'
                        });

                        // Display the user's location coordinates
                        document.getElementById('placeLngLat').innerText = "Your location is:\n" + userLocation.lng + "\n" + userLocation.lat;
                        lng = userLocation.lng;
                        lat = userLocation.lat;
                    }, function(error) {
                        handleLocationError(true);
                    });
                } else {
                    handleLocationError(false);
                }
            };

            const form = document.querySelector("#options-div form");

            form.addEventListener("submit", function(e) {
                e.preventDefault(); // Prevent form submission

                const formValue = new FormData(this);
                const searchType = document.getElementById('search-type').value;

                if (searchType === 'name') {
                    const placeName = formValue.get('name');
                    if (placeName) {
                        searchLocation(placeName);
                    }
                } else if (searchType === 'lng-lat') {
                    const latitude = parseFloat(formValue.get('latitude'));
                    const longitude = parseFloat(formValue.get('longitude'));
                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        searchByLatLng(latitude, longitude);
                    }
                }
            });
        });

        function chose() {
            var langLatDiv = document.getElementById("lng-lat");
            var nameDiv = document.getElementById("name");    
            switch (document.getElementById('search-type').value) {
                case 'lng-lat':
                    langLatDiv.style.display = 'block';
                    nameDiv.style.display = 'none';
                    break;
                case 'name':
                    nameDiv.style.display = 'block';
                    langLatDiv.style.display = 'none';
                    break;
                default:
                    nameDiv.style.display = 'none';
                    langLatDiv.style.display = 'none';
            }
        }

        function searchLocation(query) {
            const service = new google.maps.places.PlacesService(map);
            service.textSearch({ query: query }, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    const place = results[0]; // Get the first result
                    const location = place.geometry.location;

                    // Update map center and place marker
                    map.setCenter(location);
                    placeMarker(location, place.name);
                } else {
                    alert('Place not found: ' + status);
                }
            });
        }

        function searchByLatLng(lat, lng) {
            const location = new google.maps.LatLng(lat, lng);
            map.setCenter(location);
            placeMarker(location, `Latitude: ${lat}, Longitude: ${lng}`);
        }

        function placeMarker(location, title = `Selected Location: ${location.lat()}, ${location.lng()}`) {
            // If a marker already exists, remove it
            if (marker) {
                marker.setMap(null);
            }

            // Create a new marker at the clicked location
            marker = new google.maps.Marker({
                position: location,
                map: map,
                title: title
            });

            // Display the selected latitude and longitude
            document.getElementById('placeLngLat').innerText = 'Selected Location:\n' + location.lat() + "\n" + location.lng();
            lng = location.lng();
            lat = location.lat();            
        }

        function handleLocationError(browserHasGeolocation) {
            alert(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
        }
    </script>
</head>
<body>
    {% include 'header.html' %}
    <div id="container">
        <div id="map"></div>
        <div id="options-div">
            <form>
                <label for="search-type">Search by:</label>
                <select id="search-type" onchange="chose()">
                    <option value="name">Name</option>
                    <option value="lng-lat">Latitude & Longitude</option>
                </select>
                <div id="name">
                    <label for="place-name">Place Name:</label>
                    <input type="text" id="place-name" name="name" />
                </div>
                <div id="lng-lat" style="display: none;">
                    <label for="latitude">Latitude:</label>
                    <input type="number" id="latitude" name="latitude" step="any" />
                    <label for="longitude">Longitude:</label>
                    <input type="number" id="longitude" name="longitude" step="any" />
                </div>
                <button type="submit">Search</button>
                <p id="placeLngLat"></p>
            </form>
            <button id="next">Next</button>
            <div id="result">
                <div id="loader" style="display: none;"></div> <!-- Circular loader -->
            </div>
        </div>
    </div>
    {% include 'footer.html' %}

</body>
<script>
    document.getElementById("next").onclick = function(e){
        e.preventDefault()
        document.getElementById("loader").style.display="block"
        var xhr = new XMLHttpRequest()
        xhr.open("POST","/fetch");
        xhr.onreadystatechange = function(){
            if(this.readyState == 4){
                document.getElementById("loader").style.display="none"
                document.getElementById("result").innerText = this.responseText
                document.getElementById("next").style.display = "none"
            }
        }
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('User-Agent',"curl")
        xhr.send("lng="+lng+"&lat="+lat)
    }
</script>
</html>
