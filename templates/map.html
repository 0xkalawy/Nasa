<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Marker</title>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMLA-4L8ZtfBjHB3Wp-9vB83dyL4eQmbM&libraries=places&callback=initMap" defer></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }

        #start-button {
            background-color: #007BFF;
            color: #fff;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin: 20px auto;
        }

        #start-button:hover {
            background-color: #0056b3;
        }

        #start-button:active {
            transform: scale(0.98);
        }

        #start-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
        }

        #container {
            display: none;
            flex: 1;
            flex-direction: row;
        }

        #map {
            flex: 1;
            height: 100%;
        }

        #options-div {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background-color: #f8f9fa; /* Light background for contrast */
            border-left: 1px solid #dee2e6; /* Subtle border for separation */
        }

        label {
            margin: 10px 0 5px;
            font-weight: bold;
        }

        select,
        input[type="text"],
        input[type="number"] {
            padding: 10px;
            border: 1px solid #ced4da; /* Light border */
            border-radius: 5px; /* Rounded corners */
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box; /* Include padding and border in the element's total width */
        }

        select:focus,
        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: #007BFF; /* Highlight border on focus */
            outline: none; /* Remove default outline */
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); /* Add a subtle shadow */
        }

        button, 
        #next-button {
            background-color: #28a745; /* Green button */
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 10px; /* Space above button */
        }

        button:hover,
        #next-button:hover {
            background-color: #218838; /* Darker green on hover */
        }

        button:active,
        #next-button:active {
            transform: scale(0.98);
        }

        button:focus,
        #next-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.5); /* Highlight on focus */
        }

        #placeLngLat {
            margin-top: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333; /* Dark text for visibility */
        }

        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }

            #map, #options-div {
                width: 100%;
            }

            #options-div {
                padding: 10px;
            }
        }
        #loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        /* Spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        let map, marker, lng, lat;
        document.addEventListener("DOMContentLoaded", function() {
            const startButton = document.createElement("button");
            startButton.id = "start-button";
            startButton.innerText = "Start Landsat";
            document.body.insertBefore(startButton, document.getElementById("container"));

            startButton.onclick = function () {
                document.getElementById("container").style.display = "flex"; // Show the container
                this.style.display = "none"; // Hide the start button

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Create the map centered at the user's location
                        map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 14,
                            center: userLocation
                        });

                        // Add a marker at the user's location
                        marker = new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: 'You are here!'
                        });

                        // Display the user's location coordinates
                        document.getElementById('placeLngLat').innerText = "Your location is:\n" + userLocation.lng + "\n" + userLocation.lat;
                        lng = userLocation.lng;
                        lat = userLocation.lat;
                    }, function(error) {
                        handleLocationError(true);
                    });
                } else {
                    handleLocationError(false);
                }
            };

            const form = document.querySelector("#options-div form");

            form.addEventListener("submit", function(e) {
                e.preventDefault(); // Prevent form submission

                const formValue = new FormData(this);
                const searchType = document.getElementById('search-type').value;

                if (searchType === 'name') {
                    const placeName = formValue.get('name');
                    if (placeName) {
                        searchLocation(placeName);
                    }
                } else if (searchType === 'lng-lat') {
                    const latitude = parseFloat(formValue.get('latitude'));
                    const longitude = parseFloat(formValue.get('longitude'));
                    if (!isNaN(latitude) && !isNaN(longitude)) {
                        searchByLatLng(latitude, longitude);
                    }
                }
            });
        });

        function chose() {
            var langLatDiv = document.getElementById("lng-lat");
            var nameDiv = document.getElementById("name");    
            switch (document.getElementById('search-type').value) {
                case 'lng-lat':
                    langLatDiv.style.display = 'block';
                    nameDiv.style.display = 'none';
                    break;
                case 'name':
                    nameDiv.style.display = 'block';
                    langLatDiv.style.display = 'none';
                    break;
                default:
                    nameDiv.style.display = 'none';
                    langLatDiv.style.display = 'none';
            }
        }

        function searchLocation(query) {
            const service = new google.maps.places.PlacesService(map);
            service.textSearch({ query: query }, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    const place = results[0]; // Get the first result
                    const location = place.geometry.location;

                    // Update map center and place marker
                    map.setCenter(location);
                    placeMarker(location, place.name);
                } else {
                    alert('Place not found: ' + status);
                }
            });
        }

        function searchByLatLng(lat, lng) {
            const location = new google.maps.LatLng(lat, lng);
            map.setCenter(location);
            placeMarker(location, `Latitude: ${lat}, Longitude: ${lng}`);
        }

        function placeMarker(location, title = `Selected Location: ${location.lat()}, ${location.lng()}`) {
            // If a marker already exists, remove it
            if (marker) {
                marker.setMap(null);
            }

            // Create a new marker at the clicked location
            marker = new google.maps.Marker({
                position: location,
                map: map,
                title: title
            });

            // Display the selected latitude and longitude
            document.getElementById('placeLngLat').innerText = 'Selected Location:\n' + location.lat() + "\n" + location.lng();
            lng = location.lng();
            lat = location.lat();            
        }

        function handleLocationError(browserHasGeolocation) {
            alert(browserHasGeolocation ?
                'Error: The Geolocation service failed.' :
                'Error: Your browser doesn\'t support geolocation.');
        }
    </script>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="options-div">
            <form>
                <label for="search-type">Search by:</label>
                <select id="search-type" onchange="chose()">
                    <option value="name">Name</option>
                    <option value="lng-lat">Latitude & Longitude</option>
                </select>
                <div id="name">
                    <label for="place-name">Place Name:</label>
                    <input type="text" id="place-name" name="name" />
                </div>
                <div id="lng-lat" style="display: none;">
                    <label for="latitude">Latitude:</label>
                    <input type="number" id="latitude" name="latitude" step="any" />
                    <label for="longitude">Longitude:</label>
                    <input type="number" id="longitude" name="longitude" step="any" />
                </div>
                <button type="submit">Search</button>
                <p id="placeLngLat"></p>
            </form>
            <button id="next">Next</button>
            <div id="result">
                <div id="loader" style="display: none;"></div> <!-- Circular loader -->
            </div>
        </div>
    </div>
</body>
<script>
    move()
    document.getElementById("next").onclick = function(e){
        e.preventDefault()
        document.getElementById("loader").style.display="block"
        var xhr = new XMLHttpRequest()
        xhr.open("POST","/fetch");
        xhr.onreadystatechange = function(){
            if(this.readyState == 4){
                document.getElementById("loader").style.display="none"
                document.getElementById("result").innerText = this.responseText
            }
        }
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('User-Agent',"curl")
        xhr.send("lng="+lng+"&lat="+lat)
    }

    var i = 0;
        
        // Progress bar function
        function move() {
            var elem = document.getElementById("myBar");
            if (elem) { // Check if the progress bar element exists
                if (i == 0) {
                    i = 1;
                    var width = 1;
                    var id = setInterval(frame, 10); // Update every 10ms
                    
                    // Frame function updates the progress bar
                    function frame() {
                        if (width >= 100) {
                            clearInterval(id);
                            i = 0;
                        } else {
                            width++;
                            elem.style.width = width + "%";
                        }
                    }
                }
            } else {
                console.log("Progress bar element not found");
            }
        }
</script>
</html>
